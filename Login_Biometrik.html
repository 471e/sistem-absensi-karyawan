<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Biometrik</title>
    <script src="vendor/tailwindcss.js"></script>
    <script crossorigin src="vendor/react.production.min.js"></script>
    <script crossorigin src="vendor/react-dom.production.min.js"></script>
    <script src="vendor/lucide.js"></script>
    <style>
        body { font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif; background-color: #f3f4f6; }
        .scan-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: #22c55e;
            box-shadow: 0 0 4px #22c55e;
            animation: scan 2s linear infinite;
        }
        @keyframes scan {
            0% { top: 0; }
            50% { top: 100%; }
            100% { top: 0; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        const { useState, useEffect, useRef } = React;

        const DEFAULT_EMPLOYEES = [
            { "id": "AM2-001", "name": "Sahirudin, S.Kel", "workUnit": "Kantor Cabang", "role": "Kepala Unit", "password": "123", "gender": "L", "phone": "081234567890", "email": "sahirudin@example.com", "address": "Jl. Contoh No. 1", "joinDate": "2020-01-01", "nik": "3201010101010001", "npp": "NPP-001", "golongan": "III/c", "pangkat": "Penata", "masaKerja": "10 Tahun", "birthPlace": "Jakarta", "birthDate": "1980-01-01", "religion": "Islam", "maritalStatus": "Menikah", "status": "Tetap" },
            { "id": "AM2-002", "name": "Budi Santoso", "workUnit": "Kantor Cabang", "role": "Staf Administrasi", "password": "123", "gender": "L", "phone": "081234567891", "email": "budi@example.com", "address": "Jl. Contoh No. 2", "joinDate": "2021-02-01", "nik": "3201010101010002", "npp": "NPP-002", "golongan": "II/d", "pangkat": "Pengatur Tk. I", "masaKerja": "5 Tahun", "birthPlace": "Bandung", "birthDate": "1990-02-02", "religion": "Islam", "maritalStatus": "Belum Menikah", "status": "Kontrak" },
            { "id": "AM2-003", "name": "Siti Aminah", "workUnit": "Kantor Cabang", "role": "Keuangan", "password": "123", "gender": "P", "phone": "081234567892", "email": "siti@example.com", "address": "Jl. Contoh No. 3", "joinDate": "2019-03-01", "nik": "3201010101010003", "npp": "NPP-003", "golongan": "III/a", "pangkat": "Penata Muda", "masaKerja": "8 Tahun", "birthPlace": "Surabaya", "birthDate": "1992-03-03", "religion": "Islam", "maritalStatus": "Menikah", "status": "Tetap" },
            { "id": "AM2-004", "name": "Rina Wati", "workUnit": "Kantor Cabang", "role": "HRD", "password": "123", "gender": "P", "phone": "081234567893", "email": "rina@example.com", "address": "Jl. Contoh No. 4", "joinDate": "2022-04-01", "nik": "3201010101010004", "npp": "NPP-004", "golongan": "III/b", "pangkat": "Penata Muda Tk. I", "masaKerja": "3 Tahun", "birthPlace": "Yogyakarta", "birthDate": "1995-04-04", "religion": "Kristen", "maritalStatus": "Belum Menikah", "status": "Kontrak" },
            { "id": "AM2-005", "name": "Agus Setiawan", "workUnit": "Kantor Cabang", "role": "Security", "password": "123", "gender": "L", "phone": "081234567894", "email": "agus@example.com", "address": "Jl. Contoh No. 5", "joinDate": "2023-05-01", "nik": "3201010101010005", "npp": "NPP-005", "golongan": "I/d", "pangkat": "Juru Tk. I", "masaKerja": "1 Tahun", "birthPlace": "Semarang", "birthDate": "1998-05-05", "religion": "Islam", "maritalStatus": "Menikah", "status": "Outsource" }
        ];

        const DB = {
            getEmployees: () => {
                const data = JSON.parse(localStorage.getItem('employees_data') || "[]");
                if (data.length === 0) return DEFAULT_EMPLOYEES;
                return data;
            },
        };

        const ENDPOINT_KEY = "absensi_endpoint_v1";

        function buildEndpointUrl(baseUrl, params) {
            const base = (baseUrl || "").trim();
            if (!base) return "";
            const query = Object.entries(params || {})
                .filter(([_, v]) => v !== undefined && v !== null && String(v).length > 0)
                .map(([k, v]) => `${encodeURIComponent(k)}=${encodeURIComponent(String(v))}`)
                .join("&");
            if (!query) return base;
            return base + (base.includes("?") ? "&" : "?") + query;
        }

        async function jsonpRequest(url, params, { timeoutMs = 12000, retries = 2 } = {}) {
            const doRequest = () => new Promise((resolve, reject) => {
                const callbackName = `__absensi_jsonp_${Date.now()}_${Math.random().toString(16).slice(2)}`;
                const fullUrl = buildEndpointUrl(url, { ...(params || {}), callback: callbackName });
                if (!fullUrl) {
                    reject(new Error("URL kosong"));
                    return;
                }

                let settled = false;
                const cleanup = () => {
                    try { delete window[callbackName]; } catch (_) { window[callbackName] = undefined; }
                    if (script && script.parentNode) script.parentNode.removeChild(script);
                    if (timer) clearTimeout(timer);
                };

                window[callbackName] = (data) => {
                    if (settled) return;
                    settled = true;
                    cleanup();
                    resolve(data);
                };

                const script = document.createElement("script");
                script.src = fullUrl;
                script.async = true;
                script.onerror = () => {
                    if (settled) return;
                    settled = true;
                    cleanup();
                    reject(new Error("Gagal memuat data dari server"));
                };

                const timer = setTimeout(() => {
                    if (settled) return;
                    settled = true;
                    cleanup();
                    reject(new Error("Timeout mengambil data dari server"));
                }, timeoutMs);

                document.head.appendChild(script);
            });

            let lastError;
            for (let i = 0; i <= retries; i++) {
                try {
                    return await doRequest();
                } catch (e) {
                    lastError = e;
                    if (i < retries) await new Promise(r => setTimeout(r, 1000 * (i + 1)));
                }
            }
            throw lastError;
        }

        const fixSheetDate = (isoStr) => {
            if (!isoStr || isoStr === "-" || isoStr === "null") return "";
            try {
                const d = new Date(isoStr);
                if (isNaN(d.getTime())) return isoStr;
                d.setHours(d.getHours() + 12);
                return d.toISOString().slice(0, 10);
            } catch (e) {
                return isoStr;
            }
        };

        async function pullEmployeesFromSheet() {
            const baseUrl = localStorage.getItem(ENDPOINT_KEY);
            if (!baseUrl) return { ok: false, reason: "no-endpoint" };
            if (typeof navigator !== "undefined" && navigator.onLine === false) return { ok: false, reason: "offline" };

            const data = await jsonpRequest(baseUrl, { action: "export" });
            if (!data || data.status !== "success") return { ok: false, reason: "bad-response" };

            if (Array.isArray(data.employees) && data.employees.length > 0) {
                const normalizedEmployees = data.employees.map((e) => ({
                    id: String(e.id || ""),
                    name: String(e.name || ""),
                    workUnit: String(e.workUnit || ""),
                    role: String(e.role || ""),
                    password: String(e.password || "123"),
                    gender: String(e.gender || "L"),
                    phone: String(e.phone || ""),
                    email: String(e.email || ""),
                    address: String(e.address || ""),
                    joinDate: fixSheetDate(String(e.joinDate || "")),
                    nik: String(e.nik || ""),
                    npp: String(e.npp || ""),
                    golongan: String(e.golongan || ""),
                    pangkat: String(e.pangkat || ""),
                    masaKerja: String(e.masaKerja || ""),
                    birthPlace: String(e.birthPlace || ""),
                    birthDate: fixSheetDate(String(e.birthDate || "")),
                    religion: String(e.religion || ""),
                    maritalStatus: String(e.maritalStatus || ""),
                    status: String(e.status || "Kontrak"),
                    photoUrl: String(e.photoUrl || "")
                })).filter((e) => e.id);
                if (normalizedEmployees.length > 0) localStorage.setItem('employees_data', JSON.stringify(normalizedEmployees));
            }

            return { ok: true, serverTime: data.serverTime || "" };
        }

        function BiometricLogin() {
            const [mode, setMode] = useState('face'); // face, fingerprint, pin
            const [employees, setEmployees] = useState([]);
            const [selectedUser, setSelectedUser] = useState("");
            const [status, setStatus] = useState("idle"); // idle, scanning, success, error
            const videoRef = useRef(null);
            const [stream, setStream] = useState(null);
            
            // Config State
            const [showConfig, setShowConfig] = useState(false);
            const [configUrl, setConfigUrl] = useState("");

            useEffect(() => {
                const storedUrl = localStorage.getItem(ENDPOINT_KEY) || "";
                setConfigUrl(storedUrl);
                
                (async () => {
                    if (storedUrl) {
                        try { await pullEmployeesFromSheet(); } catch (_) {}
                    }
                    setEmployees(DB.getEmployees());
                })();
            }, []);

            const saveConfig = () => {
                if (configUrl) {
                    localStorage.setItem(ENDPOINT_KEY, configUrl);
                    alert("URL tersimpan! Memuat ulang data...");
                    window.location.reload();
                } else {
                    alert("URL tidak boleh kosong");
                }
            };

            useEffect(() => {
                if (mode === 'face' && status === 'idle') {
                    startCamera();
                } else {
                    stopCamera();
                }
                return () => stopCamera();
            }, [mode, status]);

            const startCamera = async () => {
                try {
                    const s = await navigator.mediaDevices.getUserMedia({ video: true });
                    setStream(s);
                    if (videoRef.current) videoRef.current.srcObject = s;
                } catch (e) {
                    console.error("Camera error", e);
                }
            };

            const stopCamera = () => {
                if (stream) {
                    stream.getTracks().forEach(t => t.stop());
                    setStream(null);
                }
            };

            const handleLoginSuccess = (user) => {
                setStatus("success");
                setTimeout(() => {
                    localStorage.setItem('session_user', JSON.stringify(user));
                    window.location.href = "Aplikasi_Karyawan.html";
                }, 1500);
            };

            const handleFaceScan = () => {
                if (!selectedUser) return alert("Pilih nama karyawan terlebih dahulu");
                setStatus("scanning");
                
                setTimeout(() => {
                    const user = employees.find(e => e.id === selectedUser);
                    if (user) handleLoginSuccess(user);
                    else setStatus("error");
                }, 2000);
            };

            const handleFingerScan = () => {
                if (!selectedUser) return alert("Pilih nama karyawan terlebih dahulu");
                setStatus("scanning");
                
                setTimeout(() => {
                    const user = employees.find(e => e.id === selectedUser);
                    if (user) handleLoginSuccess(user);
                    else setStatus("error");
                }, 2000);
            };

            return React.createElement("div", { className: "min-h-screen flex items-center justify-center p-4 bg-slate-900" },
                React.createElement("div", { className: "bg-white rounded-3xl shadow-2xl overflow-hidden w-full max-w-md" },
                    // Header
                    React.createElement("div", { className: "p-8 text-center bg-slate-50 relative" },
                        React.createElement("button", {
                            onClick: () => setShowConfig(true),
                            className: "absolute top-4 right-4 text-slate-400 hover:text-slate-600 p-2"
                        }, 
                            React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "20", height: "20", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" },
                                React.createElement("path", { d: "M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" }),
                                React.createElement("circle", { cx: "12", cy: "12", r: "3" })
                            )
                        ),
                        React.createElement("h1", { className: "text-2xl font-bold text-slate-800" }, "Login Biometrik"),
                        React.createElement("p", { className: "text-slate-500 text-sm mt-1" }, "Akses cepat tanpa password")
                    ),

                    // User Selection
                    React.createElement("div", { className: "px-8 pt-6" },
                        React.createElement("label", { className: "block text-xs font-bold text-slate-400 uppercase mb-2" }, "Pilih Karyawan"),
                        React.createElement("div", { className: "flex items-center gap-3" },
                            // Photo Preview
                            (() => {
                                const user = employees.find(e => e.id === selectedUser);
                                return React.createElement("div", { className: "w-12 h-12 flex-shrink-0 rounded-full bg-slate-100 overflow-hidden border border-slate-200" },
                                    user && user.photoUrl
                                        ? React.createElement("img", { src: user.photoUrl, className: "w-full h-full object-cover" })
                                        : React.createElement("div", { className: "w-full h-full flex items-center justify-center text-slate-400" },
                                            React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", className: "w-6 h-6", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" },
                                                React.createElement("path", { d: "M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" }),
                                                React.createElement("circle", { cx: "12", cy: "7", r: "4" })
                                            )
                                        )
                                );
                            })(),
                            
                            // Select Input
                            React.createElement("select", { 
                                className: "flex-1 p-3 bg-slate-100 rounded-xl border-none outline-none focus:ring-2 focus:ring-blue-500",
                                value: selectedUser,
                                onChange: (e) => setSelectedUser(e.target.value)
                            },
                                React.createElement("option", { value: "" }, "-- Pilih Nama --"),
                                employees.map(e => React.createElement("option", { key: e.id, value: e.id }, e.name))
                            )
                        )
                    ),

                    // Tabs
                    React.createElement("div", { className: "flex justify-center gap-4 mt-6 px-8" },
                        React.createElement("button", { 
                            onClick: () => setMode('face'),
                            className: `p-3 rounded-xl transition-all ${mode === 'face' ? 'bg-blue-600 text-white shadow-lg shadow-blue-600/30' : 'bg-slate-100 text-slate-400 hover:bg-slate-200'}`
                        }, React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" }, React.createElement("path", { d: "M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z" }), React.createElement("circle", { cx: "12", cy: "13", r: "3" }))),
                        React.createElement("button", { 
                            onClick: () => setMode('fingerprint'),
                            className: `p-3 rounded-xl transition-all ${mode === 'fingerprint' ? 'bg-purple-600 text-white shadow-lg shadow-purple-600/30' : 'bg-slate-100 text-slate-400 hover:bg-slate-200'}`
                        }, React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" }, React.createElement("path", { d: "M2 12C2 6.5 6.5 2 12 2a10 10 0 0 1 8 6" }), React.createElement("path", { d: "M5 19.5C5.5 18 6 15 6 12a6 6 0 0 1 .34-2" }), React.createElement("path", { d: "M8.63 7.17A2 2 0 0 1 9.71 5.5" }), React.createElement("path", { d: "M14 11.99V8a2 2 0 1 1 4 0v4.27A6.33 6.33 0 0 1 12 18" }), React.createElement("path", { d: "M11.99 22a10 10 0 0 1-5.07-1.39" }), React.createElement("path", { d: "M20 16a10 10 0 0 1-1.07 4.5" })))
                    ),

                    // Content Area
                    React.createElement("div", { className: "p-8 min-h-[300px] flex flex-col items-center justify-center relative" },
                        
                        // Face Mode
                        mode === 'face' && React.createElement("div", { className: "w-full text-center relative" },
                            React.createElement("div", { className: "w-48 h-48 mx-auto bg-black rounded-full overflow-hidden border-4 border-slate-200 relative mb-6" },
                                stream ? 
                                React.createElement("video", { ref: videoRef, autoPlay: true, playsInline: true, className: "w-full h-full object-cover transform scale-x-[-1]" }) :
                                React.createElement("div", { className: "w-full h-full flex items-center justify-center text-slate-500" }, "Kamera Mati"),
                                
                                status === 'scanning' && React.createElement("div", { className: "scan-line" })
                            ),
                            status === 'success' ? 
                                React.createElement("div", { className: "text-green-600 font-bold text-lg animate-bounce" }, "Wajah Terverifikasi ✓") :
                                React.createElement("button", { 
                                    onClick: handleFaceScan,
                                    disabled: !stream || status === 'scanning',
                                    className: "w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
                                }, status === 'scanning' ? "Memindai..." : "Scan Wajah")
                        ),

                        // Fingerprint Mode
                        mode === 'fingerprint' && React.createElement("div", { className: "w-full text-center" },
                            React.createElement("div", { 
                                className: `w-32 h-32 mx-auto mb-8 transition-all duration-500 ${status === 'scanning' ? 'scale-110 opacity-80' : 'scale-100'}`,
                                onClick: handleFingerScan
                            },
                                React.createElement("svg", { 
                                    xmlns: "http://www.w3.org/2000/svg", 
                                    viewBox: "0 0 24 24", 
                                    fill: "none", 
                                    stroke: status === 'success' ? "#22c55e" : status === 'scanning' ? "#9333ea" : "#cbd5e1", 
                                    strokeWidth: "1.5", 
                                    strokeLinecap: "round", 
                                    strokeLinejoin: "round",
                                    className: "w-full h-full cursor-pointer hover:stroke-purple-400 transition-colors"
                                },
                                    React.createElement("path", { d: "M2 12C2 6.5 6.5 2 12 2a10 10 0 0 1 8 6" }),
                                    React.createElement("path", { d: "M5 19.5C5.5 18 6 15 6 12a6 6 0 0 1 .34-2" }),
                                    React.createElement("path", { d: "M8.63 7.17A2 2 0 0 1 9.71 5.5" }),
                                    React.createElement("path", { d: "M14 11.99V8a2 2 0 1 1 4 0v4.27A6.33 6.33 0 0 1 12 18" }),
                                    React.createElement("path", { d: "M11.99 22a10 10 0 0 1-5.07-1.39" }),
                                    React.createElement("path", { d: "M20 16a10 10 0 0 1-1.07 4.5" })
                                )
                            ),
                            status === 'success' ? 
                                React.createElement("div", { className: "text-green-600 font-bold text-lg animate-bounce" }, "Sidik Jari Cocok ✓") :
                                React.createElement("p", { className: "text-slate-400 animate-pulse" }, "Sentuh ikon sidik jari untuk memindai")
                        )
                    ),
                    
                    React.createElement("div", { className: "bg-slate-50 p-4 text-center border-t" },
                        React.createElement("a", { href: "Aplikasi_Karyawan.html", className: "text-sm text-slate-500 hover:text-slate-800" }, "Masuk dengan ID & Password")
                    )
                ),

                // Config Modal
                showConfig && React.createElement("div", { className: "fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" },
                    React.createElement("div", { className: "bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl" },
                        React.createElement("h3", { className: "text-lg font-bold mb-4" }, "Pengaturan Server"),
                        React.createElement("div", { className: "mb-4" },
                            React.createElement("label", { className: "block text-xs font-bold text-slate-500 uppercase mb-2" }, "Google Apps Script URL"),
                            React.createElement("textarea", {
                                className: "w-full p-3 bg-slate-100 rounded-xl border border-slate-200 text-xs font-mono focus:ring-2 focus:ring-blue-500 outline-none",
                                rows: 4,
                                value: configUrl,
                                onChange: (e) => setConfigUrl(e.target.value),
                                placeholder: "https://script.google.com/macros/s/..."
                            })
                        ),
                        React.createElement("div", { className: "flex gap-2" },
                            React.createElement("button", {
                                onClick: () => setShowConfig(false),
                                className: "flex-1 py-3 text-slate-500 hover:bg-slate-100 rounded-xl font-bold"
                            }, "Batal"),
                            React.createElement("button", {
                                onClick: saveConfig,
                                className: "flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg hover:bg-blue-700"
                            }, "Simpan")
                        )
                    )
                )
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(BiometricLogin));
    </script>
</body>
</html>
